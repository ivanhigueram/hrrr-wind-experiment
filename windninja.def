Bootstrap: docker
From: ubuntu:22.04

%labels
    Author HRRR Wind Experiment
    Version 3.9.0
    Description WindNinja container for wildfire wind downscaling

%help
    WindNinja - Wind field simulation for wildfire applications
    
    This container provides WindNinja for downscaling NWP winds to 
    terrain-adjusted high-resolution (30-100m) wind fields.
    
    Usage:
        apptainer exec windninja.sif WindNinja_cli --help
        apptainer exec windninja.sif WindNinja_cli --elevation_file=dem.tif ...
    
    Supported initialization methods:
        - domainAverageInitialization: Uniform wind input
        - pointInitialization: Weather station observations
        - wxModelInitialization: NWP models (HRRR, NAM, RAP, GFS, etc.)

%post
    # Prevent interactive prompts
    export DEBIAN_FRONTEND=noninteractive
    
    # Update and install dependencies
    apt-get update && apt-get install -y \
        build-essential \
        cmake \
        git \
        wget \
        curl \
        libboost-all-dev \
        libgdal-dev \
        gdal-bin \
        libnetcdf-dev \
        libproj-dev \
        libgeotiff-dev \
        libcurl4-openssl-dev \
        libssl-dev \
        libsqlite3-dev \
        python3 \
        python3-pip \
        python3-gdal \
        && apt-get clean \
        && rm -rf /var/lib/apt/lists/*
    
    # Install WindNinja from source
    cd /opt
    git clone --depth 1 --branch v3.9.0 https://github.com/firelab/windninja.git
    
    mkdir -p /opt/windninja/build
    cd /opt/windninja/build
    
    cmake .. \
        -DCMAKE_BUILD_TYPE=Release \
        -DNINJA_CLI=ON \
        -DNINJA_GUI=OFF \
        -DNINJA_QTGUI=OFF \
        -DNINJA_MOBILE=OFF \
        -DNINJAFOAM=OFF \
        -DWITH_LCP_CLIENT=OFF \
        -DENABLE_GMTED=ON \
        -DENABLE_LANDFIRE=ON
    
    make -j$(nproc)
    make install
    
    # Add WindNinja to PATH
    echo 'export PATH="/opt/windninja/build/src/cli:$PATH"' >> /etc/bash.bashrc
    
    # Create data directories
    mkdir -p /data/input /data/output

%environment
    export PATH="/opt/windninja/build/src/cli:$PATH"
    export LD_LIBRARY_PATH="/usr/local/lib:$LD_LIBRARY_PATH"
    export GDAL_DATA="/usr/share/gdal"
    export PROJ_LIB="/usr/share/proj"
    export OMP_NUM_THREADS=${OMP_NUM_THREADS:-4}

%runscript
    exec WindNinja_cli "$@"

%test
    # Verify WindNinja is installed
    WindNinja_cli --version || echo "WindNinja_cli not found in PATH"
    
    # Verify GDAL is working
    gdalinfo --version
    
    # Check for required libraries
    ldconfig -p | grep -E "(gdal|netcdf|proj)" | head -5
